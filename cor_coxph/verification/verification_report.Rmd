---
title: "Verification Report: cor_coxph"
author: "Bhavesh Borate"
date: "`r Sys.Date()`" 
output: pdf_document
---

```{r setup, include=FALSE}
renv::activate(project = here::here(".."))
source(here::here("..", "_common.R"))

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(testthat)
library(here)

```

## Description

This is the verification report for the `cor_coxph` folder of the `correlates_reporting` project for CoVPN. 

In this document, the output of `cor_coxph.R` is compared against the output of `cor_coxph_validation.R`. The two scripts use the same base mock data. The R objects generated by the script in `cor_coxph.R` and the R datasets generated by the script in `cor_coxph_validation.R` will be compared with each other to confirm they contain the same values.

`cor_coxph_validation.R` was independently double programmed based on the specifications found in `specifications.html`. This script outputs its processing to \newline `verification/verification_output/cor_coxph_verification_output.csv`.

The R object `verification/verification_input/D57.rv.MockCOVE.Rdata` was provided by the original programmer to the tester for verification purposes of results generated for marker data at Day 57 by `cor_coxph.R`. Its md5 hash is `r digest::digest(file = here("verification/verification_input", "D57.rv.MockCOVE.Rdata"))`. The R object `verification/verification_input/D29.rv.MockCOVE.Rdata` was provided by the original programmer to the tester for verification purposes of results generated for marker data at Day 29 by `cor_coxph.R`. Its md5 hash is `r digest::digest(file = here("verification/verification_input", "D29.rv.MockCOVE.Rdata"))`.

The file `verification/verification_output/D57.mock.csv` was created by the tester for verification of results generated for marker data at Day 57 using the `cor_coxph_validation.R` script. Its md5 hash is `r digest::digest(file = here("verification/verification_output/D57.mock.csv"))`. The file `verification/verification_output/D29.mock.csv` was created by the tester for verification of results generated for marker data at Day 29 using the `cor_coxph_validation.R` script. Its md5 hash is `r digest::digest(file = here("verification/verification_output/D29.mock.csv"))`.


```{r comparison-D57}
load(here("verification", "verification_input", "D57.rv.MockCOVE.Rdata"))

verification_data <- read.csv(
  here("verification", "verification_output", "D57.mock.csv")
  )

devdat <- rv$tab.1 %>%
  data.frame()

testdat <- verification_data %>% slice(1:4) %>%
  mutate(X1 = paste0(cases, "/", formatC(atRisk, format="d", big.mark=",")),
         X2 = format(round(estimate, 2), nsmall=2),
         X3 = paste0("(", format(round(conf.low, 2), nsmall=2), "-", 
                     format(round(conf.high, 2), nsmall=2), ")"),
         X4 = ifelse(p.value < 0.001, "<0.001", format(round(p.value, 3), nsmall=3))) %>%
  select(marker, X1, X2, X3, X4) %>%
  column_to_rownames(var = "marker") 

check_vec_d57 <- vector()
# all.equal(devdat, testdat)
check_vec_d57 <- all.equal(devdat, testdat)
rm(devdat, testdat)
###################################
devdat <- rv$tab.2 %>%
  data.frame() %>%
  remove_rownames()  
  
testdat <- verification_data %>% slice(5:16) %>%
  mutate(V1 = rep(c("Lower", "Middle", "Upper"), 4),
         V2 = paste0(cases, "/", formatC(round(atRisk, 0), format="d", big.mark=",")),
         V3 = format(round(Attack.rate, 4), nsmall=4),
         est = format(round(estimate, 2), nsmall=2),
         est = ifelse(est=="1.00", "1", est),
         ci = paste0("(", format(round(conf.low, 2), nsmall=2), "-", 
                     format(round(conf.high, 2), nsmall=2), ")"),
         ci = ifelse(est=="1", "N/A", ci),
         p = ifelse(p.value < 0.001, "<0.001", format(round(p.value, 3), nsmall=3)),
         p = ifelse(est=="1", "N/A", p),
         overall.pval = ifelse(overall.pval == "", "   ", overall.pval)) %>%
  select(V1, V2, V3, est, ci, p, overall.pval) %>%
  rename(overall.p.0 = overall.pval)

# all.equal(devdat, testdat)
check_vec_d57 <- append(check_vec_d57, 
                        all.equal(devdat, testdat), 
                        after = length(check_vec_d57))
rm(devdat, testdat)
###################################
markers <- c("bindSpike", "bindRBD", "pseudoneutid50", "pseudoneutid80")
for(i in 1:4){
  devdat <- unname(rv$fr.1[i+1])[[1]] %>% 
    as.data.frame() %>% 
    t() %>%
    as.data.frame() %>% 
    mutate(marker = markers[i]) %>%
    rownames_to_column(var = "group") %>%
    mutate(group = str_trim(group, side = "left")) %>%
    select(marker, everything()) %>%
    rename(estimate = HR,
           conf.low = `(lower`,
           conf.high = `upper)`) %>%
    select(-marker)
  
  testdat <- verification_data %>% 
    filter(marker == paste0("Day57", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65, At risk", "Age < 65, Not at risk")) %>%
    select(marker, group, estimate, conf.low, conf.high, p.value) %>%
    select(-marker)
  
  nevents_verification <- verification_data %>% 
    filter(marker == paste0("Day57", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65, At risk", "Age < 65, Not at risk")) %>%
    .$cases
  
  # all.equal(devdat, testdat)
  # all.equal(rv$fr.1$nevents, nevents_verification)
  check_vec_d57 <- append(check_vec_d57, 
                          all.equal(devdat, testdat), 
                          after = length(check_vec_d57))
  check_vec_d57 <- append(check_vec_d57, 
                          all.equal(rv$fr.1$nevents, nevents_verification), 
                          after = length(check_vec_d57))
}
rm(devdat, testdat)
###################################
for(i in 1:4){
  devdat <- unname(rv$fr.2[i+1])[[1]] %>% 
    as.data.frame() %>% 
    t() %>%
    as.data.frame() %>% 
    mutate(marker = markers[i]) %>%
    rownames_to_column(var = "group") %>%
    mutate(group = str_trim(group, side = "left")) %>%
    select(marker, everything()) %>%
    rename(estimate = HR,
           conf.low = `(lower`,
           conf.high = `upper)`) %>%
    select(-marker)
  
  testdat <- verification_data %>% 
    filter(marker == paste0("Day57", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65", "At risk", "Not at risk", 
                        "Comm. of color", "WhiteNonHispanic", 
                        "Men", "Women")) %>%
    mutate(group = case_when(group == "All baseline negative, vaccine" ~ "All Vaccine",
                             group == "WhiteNonHispanic" ~ "White Non-Hispanic",
                             TRUE ~ group)) %>%
    select(marker, group, estimate, conf.low, conf.high, p.value) %>%
    select(-marker)
  
  nevents_verification <- verification_data %>% 
    filter(marker == paste0("Day57", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65", "At risk", "Not at risk", 
                        "Comm. of color", "WhiteNonHispanic", 
                        "Men", "Women")) %>%
    .$cases
  
  # all.equal(devdat, testdat)
  # all.equal(rv$fr.2$nevents, nevents_verification)
  check_vec_d57 <- append(check_vec_d57, 
                          all.equal(devdat, testdat), 
                          after = length(check_vec_d57))
  check_vec_d57 <- append(check_vec_d57, 
                          all.equal(rv$fr.2$nevents, nevents_verification), 
                          after = length(check_vec_d57))
}
rm(devdat, testdat)
```





```{r comparison-D29}

load(here("verification", "verification_input", "D29.rv.MockCOVE.Rdata"))

verification_data_d29 <- read.csv(
  here("verification", "verification_output", "D29.mock.csv")
  )

devdat <- rv$tab.1 %>%
  data.frame()

testdat <- verification_data_d29 %>% slice(1:4) %>%
  mutate(X1 = paste0(cases, "/", formatC(atRisk, format="d", big.mark=",")),
         X2 = format(round(estimate, 2), nsmall=2),
         X3 = paste0("(", format(round(conf.low, 2), nsmall=2), "-", 
                     format(round(conf.high, 2), nsmall=2), ")"),
         X4 = ifelse(p.value < 0.001, "<0.001", 
                     format(round(p.value, 3), nsmall=3))) %>%
  select(marker, X1, X2, X3, X4) %>%
  column_to_rownames(var = "marker") 

check_vec_d29 <- vector()
# all.equal(devdat, testdat)
check_vec_d29 <- all.equal(devdat, testdat)
rm(devdat, testdat)
###################################
devdat <- rv$tab.2 %>%
  data.frame() %>%
  remove_rownames() 
  
testdat <- verification_data_d29 %>% slice(5:16) %>%
  mutate(V1 = rep(c("Lower", "Middle", "Upper"), 4),
         V2 = paste0(round(cases, 0), "/", formatC(round(atRisk, 0), format="d", big.mark=",")),
         V3 = format(round(Attack.rate, 4), nsmall=4),
         est = format(round(estimate, 2), nsmall=2),
         est = ifelse(est=="1.00", "1", est),
         ci = paste0("(", format(round(conf.low, 2), nsmall=2), "-", 
                     format(round(conf.high, 2), nsmall=2), ")"),
         ci = ifelse(est=="1", "N/A", ci),
         p = ifelse(p.value < 0.001, "<0.001", format(round(p.value, 3), nsmall=3)),
         p = ifelse(est=="1", "N/A", p),
         overall.pval = ifelse(is.na(overall.pval), "   ", overall.pval)) %>%
  rename(overall.p.0 = overall.pval) %>%
  select(V1, V2, V3, est, ci, p, overall.p.0)

# all.equal(devdat, testdat)
check_vec_d29 <- append(check_vec_d29, 
                        all.equal(devdat, testdat), 
                        after = length(check_vec_d29))
rm(devdat, testdat)
###################################
markers <- c("bindSpike", "bindRBD", "pseudoneutid50", "pseudoneutid80")
for(i in 1:4){
  devdat <- unname(rv$fr.1[i+1])[[1]] %>% 
    as.data.frame() %>% 
    t() %>%
    as.data.frame() %>% 
    mutate(marker = markers[i]) %>%
    rownames_to_column(var = "group") %>%
    mutate(group = str_trim(group, side = "left")) %>%
    select(marker, everything()) %>%
    rename(estimate = HR,
           conf.low = `(lower`,
           conf.high = `upper)`) %>%
    select(-marker)
  
  testdat <- verification_data_d29 %>% 
    filter(marker == paste0("Day29", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65, At risk", "Age < 65, Not at risk")) %>%
    select(marker, group, estimate, conf.low, conf.high, p.value) %>%
    select(-marker)
  
  nevents_verification <- verification_data_d29 %>% 
    filter(marker == paste0("Day29", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65, At risk", "Age < 65, Not at risk")) %>%
    .$cases
  
  # all.equal(devdat, testdat)
  # all.equal(rv$fr.1$nevents, nevents_verification)
  check_vec_d29 <- append(check_vec_d29, 
                          all.equal(devdat, testdat), 
                          after = length(check_vec_d29))
  check_vec_d29 <- append(check_vec_d29, 
                          all.equal(rv$fr.1$nevents, nevents_verification), 
                          after = length(check_vec_d29))
}
###################################
for(i in 1:4){
  devdat <- unname(rv$fr.2[i+1])[[1]] %>% 
    as.data.frame() %>% 
    t() %>%
    as.data.frame() %>% 
    mutate(marker = markers[i]) %>%
    rownames_to_column(var = "group") %>%
    mutate(group = str_trim(group, side = "left")) %>%
    select(marker, everything()) %>%
    rename(estimate = HR,
           conf.low = `(lower`,
           conf.high = `upper)`) %>%
    select(-marker)
  
  testdat <- verification_data_d29 %>% 
    filter(marker == paste0("Day29", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65", "At risk", "Not at risk", 
                        "Comm. of color", "WhiteNonHispanic", 
                        "Men", "Women")) %>%
    mutate(group = case_when(group == "All baseline negative, vaccine" ~ "All Vaccine",
                             group == "WhiteNonHispanic" ~ "White Non-Hispanic",
                             TRUE ~ group)) %>%
    select(marker, group, estimate, conf.low, conf.high, p.value) %>%
    select(-marker)
  
  nevents_verification <- verification_data_d29 %>% 
    filter(marker == paste0("Day29", markers[i])) %>%
    filter(group %in% c("All baseline negative, vaccine", "Age >= 65", 
                        "Age < 65", "At risk", "Not at risk", 
                        "Comm. of color", "WhiteNonHispanic", 
                        "Men", "Women")) %>%
    .$cases
  
  # all.equal(devdat, testdat)
  # all.equal(rv$fr.2$nevents, nevents_verification)
  check_vec_d29 <- append(check_vec_d29, 
                          all.equal(devdat, testdat), 
                          after = length(check_vec_d29))
  check_vec_d29 <- append(check_vec_d29, 
                          all.equal(rv$fr.2$nevents, nevents_verification), 
                          after = length(check_vec_d29))
}

```



## Verification


```{r echo=FALSE}

if(all(check_vec_d57 == "TRUE")){
  clean_comparison_pass_d57 = TRUE 
  #print("All dev and test results match for Day 57 analyses.")
}else{
  clean_comparison_pass_d57 = FALSE
  #print("Mismatched values found in dev and test results for Day 57 analyses.")
}

if(all(check_vec_d29 == "TRUE")){
  clean_comparison_pass_d29 = TRUE 
  #print("All dev and test results match for Day 29 analyses.")
}else{
  clean_comparison_pass_d29 = FALSE
  #print("Mismatched values found in dev and test results for Day 29 analyses.")
}

```

Output of `cor_coxph.R` is `r ifelse(clean_comparison_pass_d57, "equivalent to", "different from")` the output of `cor_coxph_validation.R` for marker data at Day 57. Output of `cor_coxph.R` is `r ifelse(clean_comparison_pass_d29, "equivalent to", "different from")` the output of `cor_coxph_validation.R` for marker data at Day 29. `cor_coxph.R` `r ifelse(clean_comparison_pass_d57 && clean_comparison_pass_d29, "passes","fails")` verification.

## Signatures

```{r echo = FALSE, message = FALSE, tidy = FALSE, cache = FALSE, results = 'asis'}
suppressWarnings({
suppressPackageStartupMessages({
library(knitr)
library(kableExtra)
library(tibble)
})})

options(kableExtra.latex.load_packages = FALSE, 
        knitr.table.format = "latex",
        knitr.kable.NA = '',
        width = 40,
        usethis.quiet = TRUE)

signature_table <- function(people){
  # check that the tables have correct variables
  if (!all(c("role", "name") %in% tolower(names(people)))) {
    stop(paste0("people table must have variables: role and name. ",
                "Contains: ", paste0(tolower(names(people)), collapse = ", ")))
  }
  
  people$signature <- NA
  people$date <- NA
  names(people) <- tolower(names(people))
  people[, c("role", "name", "signature", "date")] %>% 
  kable(col.names = c("Role", "Name", "Signature", "Date"),
        escape = FALSE, booktabs = FALSE) %>% 
    kable_styling(full_width = FALSE, position = "left") %>% 
    row_spec(0, background = rgb(184, 204, 228, maxColorValue = 255)) %>% 
    column_spec(1, width = "9em", border_left = TRUE) %>% 
    column_spec(2, width = "11em") %>% 
    column_spec(3, width = "15em") %>% 
    column_spec(4, width = "8em", border_right = TRUE)
}

tibble::tribble(
  ~ name,                ~ role,
  "Bhavesh Borate",  "Tester"
) %>% 
  signature_table()
```
