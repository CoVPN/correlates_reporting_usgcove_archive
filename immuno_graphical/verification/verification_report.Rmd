---
title: 'Verification Report: Immunogenicity Graphs'
author: "Di Lu"
date: "2021/06/02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(testthat)
library(here)
```

```{r helper-functions, include=FALSE}
quiet<-function(x,func,...){
  x2<-try(suppressWarnings(func(x,...)),silent = TRUE)
  if(inherits(x2,'try-error')){
    return(x)
  }else{
    return(x2)
  }
}
naturalize <- function(x, round_digits = NA){
  NAs <- sum(is.na(x)| x=="NaN")
  date_formats<-c("%Y/%m/%d","%Y-%m-%d","%d-%b-%Y")
  if(sum(is.na(quiet(x,as.numeric))) == NAs){
    x <- quiet(x,as.numeric)
    if(!is.na(round_digits)){
      x <- round(x,round_digits)
    }
    return(x)
  }else if(sum(is.na(quiet(x,as.Date,tryFormats = date_formats))) == NAs){
    return(quiet(x,as.Date,tryFormats = date_formats))
  }else{
    return(x)
  }
}
# Equal test to include NA comparisons as T/F
equal <- function(x1,x2, threshold){
  
  if (is.numeric(x1) & threshold != 0) {
    x1 <- abs(x1 - x2) <= (threshold * (abs(x1 + x2)/2))
    x2 <- rep(TRUE,length(x1))
  }
  
  c <- as.character(x1) == as.character(x2)
  c[ is.na(x1) | is.na(x2) ] <- (is.na(x1) == is.na(x2) )[ is.na(x1) | is.na(x2) ]
  c
  
}
compare_datasets <- function(cols,ds1,ds2,index, verbose = TRUE, round_digits = NA, thresholds = 0){
  res <- lapply(cols,function(column_name){
    
    if(is.list(round_digits)){
      if(column_name %in% names(round_digits)){
        round_digit <- round_digits[[column_name]]
      }else{
        round_digit <- round_digits[[".default"]]
      }
    }else{
      round_digit <- round_digits
    }
    
    if(is.list(thresholds)){
      if(column_name %in% names(thresholds)){
        threshold <- thresholds[[column_name]]
      }else{
        threshold <- thresholds[[".default"]]
      }
    }else{
      threshold <- thresholds
    }
    
    
    
    v1 <- naturalize( ds1[ order( ds1[[index]] ), column_name, drop = TRUE], round_digits = round_digit)
    v2 <- naturalize( ds2[ order( ds2[[index]] ), column_name, drop = TRUE], round_digits = round_digit)
    is_equal <- equal( v1, v2 , threshold = threshold)
    if ( !all( is_equal ) & verbose)
      print( paste0("`", column_name, "` is not equal. ", sum(!is_equal),"/", max(length(v1),length(v2)), " mismatches." ) )
    
    
    
    return( list(
      equal = all( is_equal ),
      diffs = data.frame(
        key = sort(ds1[[index]])[!is_equal],
        ds1 = v1[!is_equal],
        ds2 = v2[!is_equal],
        stringsAsFactors = FALSE
        ))
      )
  })
  
  names(res) <- cols
  
  resmatched <- do.call( 'c', lapply(res,`[[`,1))
  if( verbose ){
    message( "There are ", sum(!resmatched), " mismatched fields of ", length(resmatched),'.')
  }
  
  attr(res,"index") <- index
  
  class(res) <- "comparison"
  return( res )
}
print.comparison <- function(x,...){
  n_mismatch <- do.call('c',lapply(x,function(y){
    z <- nrow(y$diffs)
    if(z>0){
      z
    }else{
      NULL
    }
  }))
  
  for(comp in names(n_mismatch)){
      message( paste0("`", comp, "` is not equal. ", n_mismatch[[comp]], " mismatches." ) )
  }
}
rerun_failed_comparisons <- function( x, ds1, ds2){
  mismatched <- names(do.call('c',lapply(x,function(y){
    if(nrow(y$diffs)>0){
      1
    }else{
      NULL
    }
  })))
  compare_datasets(mismatched, ds1, ds2, index = attr(x,"index"))
}
reformat <- function(x, digits = 1){
  format(round(as.numeric(x),digits = digits), nsmall = digits)
}
```

## Description

This is the verification report for the `immuno_graphical` folder of the `correlates_reporting` project for CoVPN. 

In the verification process, the outputs of `immuno_graphical_verification_code.R` were visually compared against the plots listed in the file `immuno_graphical/verification/verification_plan.pdf`. The values presented in the original plots were also generated independently by the tester and compared against the outputs generated by the original programmer.

The files `immuno_graphical/verification/verification_input/practice_data.csv`, \newline `immuno_graphical/verification/twophase_data.csv`, 
`immuno_graphical/verification/long_twophase_data.csv`, `spaghetti_plot_data_BaselineNeg.csv` and `spaghetti_plot_data_BaselinePos.csv` were provided by the original programmer to the tester for verification purposes.

## Data Verification

### Load `dat.twophase.sample`

```{r Load-Data1, message=FALSE}
verification.dat.twophase.sample <- read.csv(
  here("verification/output/dat.twophase.sample_verification.csv")
)

original.dat.twophase.sample<-read.csv(
  here("verification/input/twophase_data.csv")
) 


```

### Verification

```{r comparison1}
data_clean_comparison <- compare_datasets(
  cols =  colnames(verification.dat.twophase.sample), index = "Ptid",
  ds1 = verification.dat.twophase.sample, ds2 = original.dat.twophase.sample
)

```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```

`dat.twophase.sample` generated by using `immuno_graphical_verification_code.R` was `r ifelse(clean_comparison_pass, "equivalent to","different from")` the output generated by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.

### Load `dat.long.twophase.sample`

```{r Load-Data2, message=FALSE}

verification.dat.long.twophase.sample <- read.csv(
  here("verification/output/dat.long.twophase.sample_verification.csv")
)

original.dat.long.twophase.sample <- read.csv(
  here("verification/input/long_twophase_data.csv")
)

```


### Verification

```{r comparison2}

data_clean_comparison <- compare_datasets(
  cols =  colnames(verification.dat.long.twophase.sample), index = "Ptid",
  ds1 = verification.dat.long.twophase.sample, ds2 = original.dat.long.twophase.sample
)

```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```

`dat.long.twophase.sample` generated by using `immuno_graphical_verification_code.R` was `r ifelse(clean_comparison_pass, "equivalent to","different from")` the output generated by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.

## Verification of pair plots of D57 Ab markers: baseline negative vaccine arm

```{r, include=FALSE}

verification_spearman_correlation <- read.csv(
  here("verification/output/output_tester/spearman_correlation_result.csv")
) %>% arrange(x,y) %>% mutate(corr = round(corr,4))

original_spearman_correlation<-read.csv(
  here("verification/input/output_primary_programmer/spearman_correlation_result.csv")
) %>% arrange(x,y) %>% mutate(corr = round(corr,4))

```

```{r comparison6}

data_clean_comparison <- compare_datasets(
  cols =  colnames(verification_spearman_correlation),index = "corr",
  ds1 = verification_spearman_correlation, ds2 = original_spearman_correlation
)

```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```



The scatter plots and density plots generated by the teseter were visually compared with the outputs generated by original programmer, the partial Spearman's correlations calculated by tester were `r ifelse(clean_comparison_pass, "equivalent to","different from")` the partial Spearman's correlations provided by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.




## Verification of RCDF plots for D57 Ab markers: by baseline status for the vaccine arm.
```{r, include=FALSE}

original_wrcdf_list_file <- list.files(path = here("verification/input/output_primary_programmer"),pattern = "wrcdf") %>% sort()

original_wrcdf<-data.frame()

for (i in 1:length(original_wrcdf_list_file)) {
  ifelse(i == 1,
         original_wrcdf <- read.csv(
      here(paste("verification/input/output_primary_programmer/",original_wrcdf_list_file[i],sep=""))
    ),
    original_wrcdf <- read.csv(
      here(paste("verification/input/output_primary_programmer/",original_wrcdf_list_file[i],sep=""))
    ) %>% inner_join(original_wrcdf,by = "x")
  )
}

verification_wrcdf_list_file <- list.files(path = here("verification/output/output_tester"),pattern = "wrcdf") %>% sort()

verification_wrcdf<-data.frame()

for (i in 1:length(verification_wrcdf_list_file)) {
  ifelse(i == 1,
         verification_wrcdf <- read.csv(
           here(paste("verification/output/output_tester/",verification_wrcdf_list_file[i],sep=""))
         ),
         verification_wrcdf <- read.csv(
           here(paste("verification/output/output_tester/",verification_wrcdf_list_file[i],sep=""))
         ) %>% inner_join(verification_wrcdf,by = "x")
  )
}

```

```{r comparison3}

data_clean_comparison <- compare_datasets(
  cols =  colnames(verification_wrcdf), index = "x",
  ds1 = verification_wrcdf, ds2 = original_wrcdf
)

```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```

RCDF plot generated by tester was visually compared with the RCDF plot generated by the original programmer.
Key statistics(0th, 10th, 20th, 30th, 40th, 50th, 60th, 70th, 80th, 90th, 100th percentile) of RCDF calculated by tester were `r ifelse(clean_comparison_pass, "equivalent to","different from")` the key statistics provided by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.


## Verification of boxplots of D57 Ab markers: baseline negative vaccine + placebo arms
```{r, include=FALSE}

original_boxplot_list_file <- list.files(path = here("verification/input/output_primary_programmer"),
                                         pattern = "boxplots") %>% sort()

original_boxplot<-data.frame()

for (i in 1:length(original_boxplot_list_file)) {
  ifelse(i == 1,
         original_boxplot <- read.csv(
           here(paste("verification/input/output_primary_programmer/",original_boxplot_list_file[i],sep=""))
         ),
         original_boxplot <- read.csv(
           here(paste("verification/input/output_primary_programmer/",original_boxplot_list_file[i],sep=""))
         ) %>% inner_join(original_boxplot,by = "summary")
  )
}

verification_boxplot_list_file <- list.files(path = here("verification/output/output_tester"),pattern = "boxplots") %>% sort()

verification_boxplot<-data.frame()

for (i in 1:length(verification_boxplot_list_file)) {
  ifelse(i == 1,
         verification_boxplot <- read.csv(
           here(paste("verification/output/output_tester/",verification_boxplot_list_file[i],sep=""))
         ),
         verification_boxplot <- read.csv(
           here(paste("verification/output/output_tester/",verification_boxplot_list_file[i],sep=""))
         ) %>% inner_join(verification_boxplot,by = "summary")
  )
}

```

```{r comparison4}

data_clean_comparison <- compare_datasets(
  cols =  colnames(original_boxplot), index = "summary",
  ds1 = original_boxplot, ds2 = verification_boxplot
)


```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```
Boxplot generated by tester was visually compared with the boxplot generated by the original programmer.
Key statistics(min, 25th percentile, median, mean, 75th percentile, max) showed in the boxplot calculated by tester were `r ifelse(clean_comparison_pass, "equivalent to","different from")` the key statistics provided by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.


## Verification of spaghetti plots of Ab markers over time: baseline negative vaccine + placebo arm
```{r, include=FALSE}

verification_spaghetti_plot_data_BaselineNeg <- read.csv(
  here("verification/output/output_tester/spaghetti_plot_data_BaselineNeg.csv")
) %>% arrange(Ptid,Trt,Bserostatus,assay,time)


original_spaghetti_plot_data_BaselineNeg <-read.csv(
  here("verification/input/output_primary_programmer/spaghetti_plot_data_BaselineNeg.csv")
) %>% arrange(Ptid,Trt,Bserostatus,assay,time)

verification_spaghetti_plot_data_BaselinePos <- read.csv(
  here("verification/output/output_tester/spaghetti_plot_data_BaselinePos.csv")
) %>% arrange(Ptid,Trt,Bserostatus,assay,time)


original_spaghetti_plot_data_BaselinePos <-read.csv(
  here("verification/input/output_primary_programmer/spaghetti_plot_data_BaselinePos.csv")
) %>% arrange(Ptid,Trt,Bserostatus,assay,time)

verification_spaghetti_plot_data_BaselineNeg_BaselinePos <- rbind(verification_spaghetti_plot_data_BaselineNeg,
                                                                  verification_spaghetti_plot_data_BaselinePos)

original_spaghetti_plot_data_BaselineNeg_BaselinePos <- rbind(original_spaghetti_plot_data_BaselineNeg,
                                                                  original_spaghetti_plot_data_BaselinePos)

```

```{r comparison5}

data_clean_comparison <- compare_datasets(
  cols =  colnames(verification_spaghetti_plot_data_BaselineNeg_BaselinePos), index = "Ptid",
  ds1 = verification_spaghetti_plot_data_BaselineNeg_BaselinePos, ds2 = original_spaghetti_plot_data_BaselineNeg_BaselinePos
)


```
```{r echo=FALSE}

clean_comparison_pass <- all(sapply(data_clean_comparison, `[[`, "equal"))

```
Spaghetti plots generated by tester were visually compared with the Spaghetti plots generated by the original programmer.
Input data for the Spaghetti plots generated by tester was `r ifelse(clean_comparison_pass, "equivalent to","different from")` the input data provided by original programmer, and `r ifelse(clean_comparison_pass, "passes","fails")` verification.

## Signature
```{r echo = FALSE, message = FALSE, tidy = FALSE, cache = FALSE, results = 'asis'}
suppressWarnings({
suppressPackageStartupMessages({
library(knitr)
library(kableExtra)
library(tibble)
})})
options(kableExtra.latex.load_packages = FALSE, 
        knitr.table.format = "latex",
        knitr.kable.NA = '',
        width = 40,
        usethis.quiet = TRUE)
signature_table <- function(people){
  # check that the tables have correct variables
  if (!all(c("role", "name") %in% tolower(names(people)))) {
    stop(paste0("people table must have variables: role and name. ",
                "Contains: ", paste0(tolower(names(people)), collapse = ", ")))
  }
  
  people$signature <- NA
  people$date <- NA
  names(people) <- tolower(names(people))
  people[, c("role", "name", "signature", "date")] %>% 
  kable(col.names = c("Role", "Name", "Signature", "Date"),
        escape = FALSE, booktabs = FALSE) %>% 
    kable_styling(full_width = FALSE, position = "left") %>% 
    row_spec(0, background = rgb(184, 204, 228, maxColorValue = 255)) %>% 
    column_spec(1, width = "9em", border_left = TRUE) %>% 
    column_spec(2, width = "11em") %>% 
    column_spec(3, width = "15em") %>% 
    column_spec(4, width = "8em", border_right = TRUE)
}
tibble::tribble(
  ~ name,                ~ role,
  "Di Lu",  "Tester"
) %>% 
  signature_table()
```


