---
title: "CoVPN COVID-19 Vaccine Efficacy Trial Immunogenicity Report - Verification"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
  pdf_document:
    df_print: kable
    toc: yes
    toc_depth: 2
classoption: landscape
header-includes: \usepackage{caption}
---

```{r setup, include=FALSE, echo=FALSE}
  library(tidyverse)
  library(Hmisc)
  library(survey)
  options(scipen=999) # Turn off scientific notation
  options(survey.lonely.psu="adjust") 
  renv::activate(project = here::here(".."))
  
  ## variables setting
  study_name = "ENSEMBLE"
  study_name_code = "ENSEMBLE"
  data_in_file = "janssen_pooled_mock_data_processed.csv"
  #study_name = "COVE"
  #study_name_code = "COVE"
  #data_in_file = ""
  source(here::here("..", "_common.R"))
```

```{r dataio, echo=FALSE}

# read in practice data
dat.mock <- read.csv(here("verification","verification_input", data_in_file), stringsAsFactors = F)

# Filter the data to the phase 1 ptids of the immunogenicity cohort, create immuno_ind for phase 2 ptids
dat <- subset(dat.mock, ph1.immuno==1)
dat$immuno_ind <- dat$ph2.immuno

# LLOD truncation being taken care of upstream

# wide to long by marker and timepoint
times_assays <- paste(rep(times, each = length(assays)+1), c("bindN", assays), sep = "")

dat.long <- dat %>%
  pivot_longer(times_assays[times_assays %in% colnames(dat)], names_to = "times_assays", values_to = "readout_trunc") %>%
  mutate(time = gsub(paste0(c("bindN", assays), collapse="|","$"), "", times_assays),
         marker = gsub(paste0(paste0("^",times), collapse="|"), "", times_assays))

# define subgroups: age, risk, age & risk, sex, EthnicityHispanic, race, minority, age & minority etc
dat.long <- dat.long %>%
  mutate(
    AgeC = case_when(
      (.GlobalEnv$study_name == "COVE" & Age >= 65) ~ "Age >= 65",
      (.GlobalEnv$study_name == "COVE" & Age < 65) ~ "Age < 65",
      Age >= 60 ~ "Age >= 60",
      Age < 60 ~ "Age 18 - 59",
      TRUE ~ NA_character_
      ),
    HighRiskC = ifelse(HighRiskInd == 1, "At-risk", "Not at-risk"
                       ),
    SexC = ifelse(Sex == 1, "Female", ifelse(Sex == 0, "Male", NA)),
    EthHisC = case_when(
      EthnicityHispanic==1 ~ "Hispanic or Latino",
      (EthnicityHispanic==0 & EthnicityNotreported==0 & EthnicityUnknown==0) ~ "Not Hispanic or Latino",
      (EthnicityNotreported==1 | EthnicityUnknown==1) ~ "Not reported and unknown ", 
      TRUE ~ NA_character_
      ),
    RaceEthC = as.character(race),
    MinorityC = case_when(
      (.GlobalEnv$study_name == "COVE" & WhiteNonHispanic == 0) ~ "Communities of Color",
      (.GlobalEnv$study_name == "COVE" & WhiteNonHispanic == 1) ~ "White Non-Hispanic",
      URMforsubcohortsampling == 1 ~ "URM",
      URMforsubcohortsampling == 0 ~ "Non-URM",
      TRUE ~ NA_character_
      ),
    AgeRiskC = paste(AgeC, HighRiskC),
    AgeSexC = paste(AgeC, SexC),
    AgeMinorC = ifelse(!is.na(MinorityC), paste(AgeC, MinorityC), NA),
    HIVinfectionC = ifelse(HIVinfection == 1, "Positive", ifelse(HIVinfection == 0, "Negative", NA)),
    BMIC = case_when(
      BMI < 18.5 ~ "Underweight BMI < 18.5",
      BMI <= 25 ~ "Normal 18.5 <= BMI < 25",
      BMI < 30 ~ "Overweight 25 <= BMI < 30",
      BMI >=30 ~ "Obese BMI >= 30"
    ))

if (study_name == "ENSEMBLE") {
  dat.long$CountryC = labels.countries.ENSEMBLE[as.character(dat.long$Country)]
}

# create a new RaceEthC including white hispanic for demographic table reporting
dat.long$RaceEthC2=dat.long$RaceEthC
# code white non-hispanic group and set white hispanic as NA
dat.long$RaceEthC[which(dat.long$RaceEthC == 'White' & dat.long$WhiteNonHispanic == 1)] <- 'White Non-Hispanic '
dat.long$RaceEthC[which(dat.long$RaceEthC == 'White')] <- NA

# define response variables
dat.long <- dat.long %>% 
  mutate(LLoD = llods[as.character(marker)],
         LLoQ = lloqs[as.character(marker)],
         pos.cutoffs = pos.cutoffs[as.character(marker)],
         
         LLoX = LLoQ,
         
         bind_response_2LLoX = ifelse(grepl("bind", marker) & readout_trunc>=log10(2*LLoX) & !grepl("Delta",time), 1, ifelse(grepl("bind", marker) & readout_trunc<log10(2*LLoX) & !grepl("Delta",time), 0, NA)),
         bind_response_4LLoX = ifelse(grepl("bind", marker) & readout_trunc>=log10(4*LLoX) & !grepl("Delta",time), 1, ifelse(grepl("bind", marker) & readout_trunc<log10(4*LLoX) & !grepl("Delta",time), 0, NA)),
         
         baseline_lt_thres = ifelse(time=="B" & readout_trunc >= log10(LLoX), 1, 0),
         increase_4F_D29 = ifelse(time=="Delta29overB" & readout_trunc>log10(4), 1, 0),
         increase_4F_D57 = ifelse(time=="Delta57overB" & readout_trunc>log10(4), 1, 0),
         
         response_2FR = ifelse(grepl("Delta",time) & readout_trunc>=log10(2), 1, 
                               ifelse(grepl("Delta",time) & readout_trunc<log10(2), 0, NA)),
         response_4FR = ifelse(grepl("Delta",time) & readout_trunc>=log10(4), 1, 
                               ifelse(grepl("Delta",time) & readout_trunc<log10(4), 0, NA))
         ) %>%
  group_by(Ptid, marker) %>%
  mutate(baseline_lt_thres_ptid=max(baseline_lt_thres),
         increase_4F_D29_ptid=max(increase_4F_D29),
         increase_4F_D57_ptid=max(increase_4F_D57)) %>%
  ungroup() %>%
  mutate(response_nab = ifelse(!grepl("Delta",time) & !grepl("bind",marker),
                               case_when(
                                 (baseline_lt_thres_ptid == 0 & readout_trunc > log10(LLoX)) ~ 1,
                                 (baseline_lt_thres_ptid == 1 & time == "B") ~ 1,
                                 (baseline_lt_thres_ptid == 1 & time == "Day29" & increase_4F_D29_ptid==1) ~ 1,
                                 (baseline_lt_thres_ptid == 1 & time == "Day57" & increase_4F_D57_ptid==1) ~ 1,
                                 TRUE ~ 0
                                 ), NA),
         response_bab = ifelse(!grepl("Delta",time) & grepl("bind",marker),
                               case_when(
                                 readout_trunc > log10(pos.cutoffs) ~ 1,
                                 readout_trunc <= log10(pos.cutoffs) ~ 0
                                 ), NA),
         response = ifelse(grepl("bind",marker), response_bab, response_nab)
         )

# label Trt, Bserostatus, time and marker
dat.long$Trt_lb = ifelse(dat.long$Trt == 0, "Placebo", "Vaccine")
dat.long$Baseline = ifelse(dat.long$Bserostatus== 0, "Negative","Positive")
dat.long$Visit = labels.time[as.character(dat.long$time)]
dat.long$Marker = labels.assays.short.tabular[as.character(dat.long$marker)]

# looping list for tables
# variable with groups and label name
dat.long$Allparticipants=""
VarName_levels <- list(
  `Allparticipants`="All participants",
  `AgeC`="Age",
  `HighRiskC`="Risk for Severe Covid-19",
  `AgeRiskC`="Age, Risk for Severe Covid-19",
  `SexC`="Sex",
  `EthHisC`="Hispanic or Latino ethnicity",
  `RaceEthC`="Race",
  `MinorityC`=ifelse(study_name=="COVE", "Communities of color", "Underrepresented Minority Status in the U.S."),
  `AgeMinorC`=ifelse(study_name=="COVE", "Age, Communities of color","Age, Underrepresented Minority Status in the U.S."),
  `AgeSexC`="Age, sex",
  `Trt_lb`="Arm",
  `Baseline`="Baseline SARS-CoV-2",
  `HIVinfectionC`="HIV Infection")

if(study_name=="ENSEMBLE") VarName_levels[["CountryC"]]="Country"

# parameters set-up
tbl_num <- 1
groupby_vars=c("VarName","Group","Baseline", "Trt_lb", "Marker", "Visit")
two_timepoints=c("Day 29")
three_timepoints=c("Day 1","Day 29")
  
## functions
decimal_f <- function(x, d) { # rounding values
  trimws(format(round(x, d), nsmall=d))
}

# load all immuno tabs from Chenchen
load(here("verification","verification_input","Tables_immuno.Rdata"), verbose=T)

```

\captionsetup[table]{labelformat=empty}

\clearpage

## Table. Demographic  

```{r tab_dm, results = "asis", echo=FALSE, message=FALSE}
fig_footer <- c("This table summarises the case-cohort, which measures antibody markers at (Day 1, Day 29, and Day 57)")
 
for (i in c("Positive", "Negative")){
  
  demo <- subset(dat.long, Baseline==i & immuno_ind==1)[, c("Trt_lb","Ptid","RaceEthC2", colnames(dat.long)[grepl("C$", colnames(dat.long))])] %>% 
    mutate(MinorityC = ifelse(is.na(MinorityC), "NA", MinorityC),
           HIVinfectionC = ifelse(is.na(HIVinfectionC), "NA", HIVinfectionC)) %>%
    unique()
  
  if (study_name=="COVE"){
    demo <- demo %>% 
      mutate(AgeRiskC=ifelse(grepl("Age >= 65", AgeRiskC), "Age >= 65 ", AgeRiskC))
  }
  
  demo.long <- demo %>%
    pivot_longer(!c(Trt_lb, Ptid), names_to = "VarName", values_to="Group")
  
  tab_dm_by_trt <- demo.long %>% 
    group_by(Trt_lb, VarName, Group) %>% 
    filter(!is.na(Group)) %>%
    summarise(N=n()) %>% 
    mutate(n_freq = paste0(N, " (", decimal_f( N / sum(N) * 100, 1),"%)")) %>% 
    select(-N) %>%
    pivot_wider(names_from = "Trt_lb", values_from = "n_freq") %>% 
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% mutate(Trt_lb = ifelse(Trt==0, "Placebo", "Vaccine")) %>%
        group_by(Trt_lb) %>% 
        summarise(age=paste0(decimal_f(mean(Age),1), " (", decimal_f(min(Age),1),", ",decimal_f(max(Age),1),")")) %>%
        pivot_wider(names_from = "Trt_lb", values_from="age") %>%
        mutate(VarName="AgeC",
               Group="Mean (Range)")
    ) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% mutate(Trt_lb = ifelse(Trt==0, "Placebo", "Vaccine")) %>%
        group_by(Trt_lb) %>% 
        summarise(BMI=paste0(decimal_f(mean(BMI),1), " +/- ", decimal_f(sd(BMI),1))) %>%
        pivot_wider(names_from = "Trt_lb", values_from="BMI") %>%
        mutate(VarName="BMI",
               Group="Mean +/- SD")
    )
  
  tab_dm_tot<- demo.long %>% 
    group_by(VarName, Group) %>% 
    filter(!is.na(Group)) %>%
    summarise(N=n()) %>% 
    mutate(Total = paste0(N, " (", decimal_f( N / sum(N) * 100, 1),"%)")) %>% 
    select(-N) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% 
        summarise(Total=paste0(decimal_f(mean(Age),1), " (", decimal_f(min(Age),1),", ",decimal_f(max(Age),1),")")) %>%
        mutate(VarName="AgeC",
               Group="Mean (Range)")
    ) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% 
        summarise(Total=paste0(decimal_f(mean(BMI),1), " +/- ", decimal_f(sd(BMI),1))) %>%
        mutate(VarName="BMI",
               Group="Mean +/- SD")
    )
  
  
  tab_dm <- tab_dm_by_trt %>%
    left_join(tab_dm_tot,  by=c("VarName","Group")) %>%
    filter(!is.na(Group)) %>%
    mutate(VarName=case_when(VarName=="AgeRiskC" ~ "Age, Risk for Severe Covid-19", 
                             VarName=="HighRiskC" ~ "Risk for Severe Covid-19", 
                             VarName=="EthHisC" ~ "Hispanic or Latino ethnicity", 
                             VarName=="RaceEthC2" ~ "Race", 
                             VarName=="MinorityC" ~ "Underrepresented Minority Status in the U.S.",
                             VarName=="CountryC" ~ "Country",
                             VarName=="AgeC" ~ "Age", 
                             VarName=="SexC" ~ "Sex",
                             VarName=="BMIC" ~ "BMI",
                             VarName=="HIVinfectionC" ~ "HIV Infection",
                             TRUE ~ VarName)) %>%
    select(VarName, Group, Placebo, Vaccine, Total)
  
  
  count <- demo %>% group_by(Trt_lb) %>%  summarise(N=n())
  
  colnames(tab_dm) = c("subgroup", "Characteristics", paste0(count$Trt_lb,"\n(N = ",count$N,")"), paste0("Total\n(N = ", sum(count$N),")"))
  
  tab_dm <- tab_dm %>% select(1,2,4,3,5)

   if (i=="Positive"){
    # comparison
    tab_dm_pos[] <- lapply(tab_dm_pos, as.character)
    tab_dm_pos_v = tab_dm_pos[, c("subgroup","Characteristics")] %>% left_join(tab_dm, by=c("subgroup","Characteristics"), all.x=T)
    testthat::expect_equal(tab_dm_pos_v, tab_dm_pos)
    
    save(tab_dm_pos_v, file = here::here("verification", "verification_output", "immuno_tab_dm_pos_v.Rdata"))
  } else if (i=="Negative"){
    # comparison
    tab_dm_neg[] <- lapply(tab_dm_neg, as.character)
    tab_dm_neg_v = tab_dm_neg[, c("subgroup","Characteristics")] %>% left_join(tab_dm, by=c("subgroup","Characteristics"), all.x=T)
    testthat::expect_equal(tab_dm_neg_v, tab_dm_neg)
    
    save(tab_dm_neg_v, file = here::here("verification", "verification_output", "immuno_tab_dm_neg_v.Rdata"))
  }
}
```

\clearpage

## Table. Observed/Estimated participant counts by randomization strata

```{r tab_strtm, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}

for (i in list(c(1:8), c(9:16))){
  
    strata_dat <- unique(subset(dat.long, immuno_ind==1 & demo.stratum %in% unlist(i))[, c("Ptid","demo.stratum","Trt_lb","Baseline","wt.subcohort")])
    
    three_way <- as.data.frame(table(strata_dat$Baseline,strata_dat$Trt_lb,strata_dat$demo.stratum))
    colnames(three_way) <- c("Baseline","Trt_lb","demo.stratum","count")
    
    wt <- unique(strata_dat[,c("demo.stratum","Trt_lb","Baseline","wt.subcohort")])
    
    three_way2 <- merge(three_way, wt, by=c("demo.stratum","Trt_lb","Baseline")) 
    
    three_way2$count_wt=three_way2$count * three_way2$wt
    
    tab_strtm_v <- three_way2 %>% select(3,2,1,6,4)
    colnames(tab_strtm_v) <- c("Baseline SARS-CoV-2","Arm","strata","Estimated","Observed")
    tab_strtm_v <- tab_strtm_v %>%
      mutate_at(c("Baseline SARS-CoV-2","Arm","Estimated","Observed"), as.character) %>%
      mutate_at(c("strata"), as.numeric)
    
    if (i==c(1:8)){
      
    tab_strtm1_v <- tab_strtm1[, c("Baseline SARS-CoV-2","Arm","strata")] %>%
      left_join(tab_strtm_v, by=c("Baseline SARS-CoV-2","Arm","strata"))
    
    testthat::expect_equal(tab_strtm1_v, tab_strtm1)
    
    save(tab_strtm1_v, file = here::here("verification", "verification_output", "immuno_tab_strtm1_v.Rdata"))
    } else if (i==c(9:16)){
      
    tab_strtm2_v <- tab_strtm2[, c("Baseline SARS-CoV-2","Arm","strata")] %>%
      left_join(tab_strtm_v, by=c("Baseline SARS-CoV-2","Arm","strata"))
    
    testthat::expect_equal(tab_strtm2_v, tab_strtm2)
    
    save(tab_strtm2_v, file = here::here("verification", "verification_output", "immuno_tab_strtm2_v.Rdata"))
    }
}
```

\clearpage

## Table. Percentage of responders, and participants with concentrations >= 2 x LLoX or >= 4 x LLoX for binding antibody markers by All participants

```{r tab_bind1, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}

ind=1
tab_list=list()
for (v in seq_along(VarName_levels)){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)")){
    for (tp in two_timepoints){
      
      letter=letters[ind]
      
       immuno_design <- dat.long %>%
         mutate(Group=(!!sym(names(VarName_levels[v]))),
                VarName=VarName_levels[[v]]) %>%
         filter(Visit == tp & Marker == mk)
       
       design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design)
       
       mod1 <- svyby(~response,  by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod1) <- c(colnames(mod1)[1:7], "mod1 2.5 %", "mod1 97.5 %")
       
       mod2 <- svyby(~bind_response_2LLoX, by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod2) <- c(colnames(mod2)[1:7], "mod2 2.5 %", "mod2 97.5 %")
       
       mod3 <- svyby(~bind_response_4LLoX, by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod3) <- c(colnames(mod3)[1:7], "mod3 2.5 %", "mod3 97.5 %")
       
       tab <-  immuno_design %>% filter(immuno_ind==1 & !is.na(Group)) %>%
        group_by_at(groupby_vars) %>%
        summarise(N=as.character(n()),
                  `Responder_1`=paste0(round(sum(response * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                  `% Greater than 2xLLOX_1`=paste0(round(sum(bind_response_2LLoX * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                  `% Greater than 4xLLOX_1`=paste0(round(sum(bind_response_4LLoX * wt.subcohort),1),"/",round(sum(wt.subcohort),1))) %>%
         left_join(mod1, by=groupby_vars) %>%
         left_join(mod2, by=groupby_vars) %>%
         left_join(mod3, by=groupby_vars) %>%
         mutate(`Responder_2` = ifelse(!is.nan(`mod1 97.5 %`), paste0(decimal_f(response*100,1),"%\n(", decimal_f(`mod1 2.5 %`*100,1),"%, ", decimal_f(`mod1 97.5 %`*100,1),"%)"), paste0(decimal_f(response*100,1),"%")),
                `% Greater than 2xLLOX_2` = ifelse(!is.nan(`mod2 97.5 %`), paste0(decimal_f(bind_response_2LLoX*100,1),"%\n(", decimal_f(`mod2 2.5 %`*100,1),"%, ", decimal_f(`mod2 97.5 %`*100,1),"%)"), paste0(decimal_f(bind_response_2LLoX*100,1),"%")),
                `% Greater than 4xLLOX_2` = ifelse(!is.nan(`mod3 97.5 %`), paste0(decimal_f(bind_response_4LLoX*100,1),"%\n(", decimal_f(`mod3 2.5 %`*100,1),"%, ", decimal_f(`mod3 97.5 %`*100,1),"%)"), paste0(decimal_f(bind_response_4LLoX*100,1),"%"))
                ) %>%
         mutate(`Responder` = paste0(`Responder_1`, " = ", `Responder_2`),
                `% Greater than 2xLLOX` = paste0(`% Greater than 2xLLOX_1`, " = ", `% Greater than 2xLLOX_2`),
                `% Greater than 4xLLOX` = paste0(`% Greater than 4xLLOX_1`, " = ", `% Greater than 4xLLOX_2`)) %>%
         select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, `Responder`:`% Greater than 4xLLOX`)
      
      tab_list[[ind]] <- tab
      
      ind=ind+1
    }
  }
}

# comparison
tab_bind1_v <- do.call("rbind", tab_list)
colnames(tab_bind1_v) <- c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker","N","Responder", "% Greater than 2xLLOQ", "% Greater than 4xLLOQ")

tab_bind1_v = tab_bind1[,c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>% left_join(tab_bind1_v, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(tab_bind1_v, tab_bind1)

save(tab_bind1_v, file = here::here("verification", "verification_output", "immuno_tab_bind1_v.Rdata"))
```

\clearpage

## Table. Binding antibody markers with % 2-fold rise and % 4-fold rise
## Table. Percentage of responders, and participants participants with 2-fold rise, and participants with 4-fold rise for ID50 pseudo-virus neutralization antibody markers
## Table. Percentage of responders, and participants participants with 2-fold rise, and participants with 4-fold rise for MN50 WT live virus neutralization antibody markers

```{r tab_bind2_tab_pseudo_tab_wt, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}
ind=1
tab_list=list()
for (v in seq_along(VarName_levels)){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in two_timepoints){
  
    letter=letters[ind]
    
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels[v]))),
                VarName=VarName_levels[[v]]) %>%
      filter(Marker == mk & Visit == tp) %>%
      select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum, response, immuno_ind) %>%
      left_join(
        dat.long %>%
          mutate(Group=(!!sym(names(VarName_levels[v]))),
                 VarName=VarName_levels[[v]]) %>%
        filter(Marker == mk & grepl("D29 fold-rise over D1|D57 fold-rise over D1", Visit)) %>%
        mutate(Visit=ifelse(Visit=="D29 fold-rise over D1","Day 29",
                            ifelse(Visit=="D57 fold-rise over D1","Day 57", NA))) %>%
        select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum, response_2FR, response_4FR),
        by=c("Ptid",groupby_vars, "wt.subcohort", "tps.stratum")
      )
    
     design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design)
  
     mod1 <- svyby(~response, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod1) <- c(colnames(mod1)[1:7], "mod1 2.5 %", "mod1 97.5 %")
     
     mod2 <- svyby(~response_2FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod2) <- c(colnames(mod2)[1:7], "mod2 2.5 %", "mod2 97.5 %")
     
     mod3 <- svyby(~response_4FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop,ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod3) <- c(colnames(mod3)[1:7], "mod3 2.5 %", "mod3 97.5 %")
     
     tab <-  immuno_design %>% filter(immuno_ind==1 & !is.na(Group)) %>%
      group_by_at(groupby_vars) %>%
      summarise(N=as.character(n()),
                `Responder_1`=paste0(round(sum(response * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 2-fold rise_1`=paste0(round(sum(response_2FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 4-fold rise_1`=paste0(round(sum(response_4FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1))) %>%
       left_join(mod1, by=groupby_vars) %>%
       left_join(mod2, by=groupby_vars) %>%
       left_join(mod3, by=groupby_vars) %>%
       mutate(`Responder_2` = ifelse(!is.nan(`mod1 97.5 %`), paste0(decimal_f(response*100,1),"%\n(", decimal_f(`mod1 2.5 %`*100,1),"%, ", decimal_f(`mod1 97.5 %`*100,1),"%)"),paste0(decimal_f(response*100,1),"%")),
              `% 2-fold rise_2` = ifelse(!is.nan(`mod2 97.5 %`), paste0(decimal_f(response_2FR*100,1),"%\n(", decimal_f(`mod2 2.5 %`*100,1),"%, ", decimal_f(`mod2 97.5 %`*100,1),"%)"),paste0(decimal_f(response_2FR*100,1),"%")),
              `% 4-fold rise_2` = ifelse(!is.nan(`mod3 97.5 %`), paste0(decimal_f(response_4FR*100,1),"%\n(", decimal_f(`mod3 2.5 %`*100,1),"%, ", decimal_f(`mod3 97.5 %`*100,1),"%)"),paste0(decimal_f(response_4FR*100,1),"%"))
              ) %>%
       mutate(`Responder` = paste0(`Responder_1`, " = ", `Responder_2`),
              `% 2-fold rise` = paste0(`% 2-fold rise_1`, " = ", `% 2-fold rise_2`),
              `% 4-fold rise` = paste0(`% 4-fold rise_1`, " = ", `% 4-fold rise_2`)) %>%
       select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, `Responder`:`% 4-fold rise`)
    
    tab_list[[ind]] <- tab
    
    ind=ind+1
    }
  }
}

# comparison
tab_bind2_v <- do.call("rbind", tab_list) %>% filter(Marker %in% c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"))
colnames(tab_bind2_v) <- c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker","N","Responder", "% 2-Fold Rise", "% 4-Fold Rise")

tab_bind2_v <- tab_bind2[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>%
  left_join(tab_bind2_v, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(tab_bind2_v, tab_bind2)

save(tab_bind2_v, file = here::here("verification", "verification_output", "immuno_tab_bind2_v.Rdata"))

# comparison
if (c("Pseudovirus-nAb ID50","Pseudovirus-nAb ID80") %in% unique(dat.long$marker)){
  tab_pseudo_v <- do.call("rbind", tab_list) %>% filter(Marker %in% c("Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"))
  colnames(tab_pseudo_v) <- c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker","N","Responder", "% 2-fold rise", "% 4-fold rise")
  
  tab_pseudo_sub_v <- tab_pseudo[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>%
    left_join(tab_pseudo_v, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))
  
  testthat::expect_equal(tab_pseudo_sub_v, tab_pseudo)
  
  save(tab_pseudo_sub_v, file = here::here("verification", "verification_output", "immuno_tab_pseudo_v.Rdata"))
}

```

\clearpage

## Table. Geometric mean titers (GMTs) and geometric mean concentrations (GMCs)    

```{r tab_gm, results = "asis", echo=FALSE, message=FALSE}

ind=1
tab_list=list()
for (v in seq_along(VarName_levels)){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in three_timepoints){
  
    letter=letters[ind]
    
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels[v]))),
             VarName=VarName_levels[[v]]) %>%
      filter(Marker==mk & Visit == tp)
    
    design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design)
    
    mod = svyby(~readout_trunc, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, svymean, ci=TRUE, vartype="ci", na.rm=T)
    
    tab <- immuno_design %>% filter(immuno_ind==1 & !is.na(Group)) %>%
      group_by_at(groupby_vars) %>%
      summarise(N=as.character(n())) %>%
      left_join(mod, by=groupby_vars) %>%
      mutate(GMT = paste0(decimal_f(10^readout_trunc, 2),"\n(", decimal_f(10^ci_l, 2),", ", decimal_f(10^ci_u,2),")")) %>%
      select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, GMT)
    
    tab_list[[ind]] <- tab
  
    ind=ind+1
    }
  }
}

# comparison
tab_gm_v <- do.call("rbind", tab_list)
colnames(tab_gm_v) <- c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker","N","GMT/GMC")

tab_gm_v <- tab_gm[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>% left_join(tab_gm_v, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(tab_gm_v, tab_gm)

save(tab_gm_v, file = here::here("verification", "verification_output", "immuno_tab_gm_v.Rdata"))
```

\clearpage

## Table. Geometric mean titer ratios (GMTRs) or geometric mean concentration ratios (GMCRs) between post-vaccinations/pre-vaccination

```{r tab_gmr, results = "asis", echo=FALSE, warning=FALSE, message=F}

ind=1
tab_list=list()
for (v in seq_along(VarName_levels)){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in c("D29 fold-rise over D1", if(has57)"D57 fold-rise over D1")){
  
    letter=letters[ind]
    
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels[v]))),
             VarName=VarName_levels[[v]]) %>%
      filter(Marker == mk & Visit == tp)
      
    design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design)
    
    mod <- svyby(~readout_trunc, ~VarName+Group+Visit+Baseline+Trt_lb+Marker, design, svymean, ci=TRUE, vartype="ci", na.rm=T)
    
    tab <-  mod %>%
        mutate(`GMTR/GMCR`= paste0(decimal_f(10^readout_trunc,2), "\n(", decimal_f(10^ci_l,2), ", ", decimal_f(10^ci_u,2),")")) %>%
        select(VarName, Group, Baseline, Trt_lb, Marker, `GMTR/GMCR`, Visit)
    
    tab_list[[ind]] <- tab
  
    ind=ind+1
    }
  }
}

# comparison
tab_gmr_v <- do.call("rbind", tab_list)
colnames(tab_gmr_v) <- c("subgroup", "Group", "Baseline SARS-CoV-2", "Arm", "Marker", "GMTR/GMCR","Visit")

# merge with gm
tab_gmr_v <- merge(tab_gmr_v, (tab_gm_v %>% pivot_wider(names_from=Visit, values_from=`GMT/GMC`)), by=c("subgroup","Group","Arm","Baseline SARS-CoV-2","Marker"))

# format
tab_gmr_v$`Baseline\nGMT/GMC`=tab_gmr_v$`Day 1`
tab_gmr_v$`Post Baseline\nGMT/GMC`=with(tab_gmr_v, ifelse(tab_gmr_v$Visit=="D29 fold-rise over D1", `Day 29`, `Day 57`))
tab_gmr_v <- tab_gmr_v[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2",
                           "Marker","N","Baseline\nGMT/GMC","Post Baseline\nGMT/GMC",
                           "GMTR/GMCR")]

tab_gmr_v <- tab_gmr[, c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker")] %>% left_join(tab_gmr_v, by=c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(tab_gmr_v, tab_gmr)

save(tab_gmr_v, file = here::here("verification", "verification_output", "immuno_tab_gmr_v.Rdata"))
```

\clearpage

## Table. The ratios of GMTs/GMCs between groups

```{r tab_rgmt, results = "asis", echo=FALSE, message=FALSE}

ind=1
ind_comp=1
tab_list=list()

if (study_name=="COVE") {
  younger_age="Age < 65"; older_age="Age >= 65"
  minortiy_grp1="Communities of color"; minortiy_grp2="White Non-Hispanic"
}
if (study_name=="ENSEMBLE") {
  younger_age="Age 18 - 59"; older_age="Age >= 60"
  minortiy_grp1="URM"; minortiy_grp2="Non-URM"
}

cps=c("Age","Age, Risk for Severe Covid-19","Age, Risk for Severe Covid-19","Sex","Hispanic or Latino ethnicity", VarName_levels[["MinorityC"]], "Risk for Severe Covid-19", "HIV Infection")
group1=c(older_age, paste(younger_age, "At-risk"), paste(older_age,  "At-risk"), "Male", "Hispanic or Latino", minortiy_grp1, "At-risk", "Positive")
group2=c(younger_age, paste(younger_age, "Not at-risk"), paste(older_age, "Not at-risk"), "Female", "Not Hispanic or Latino", minortiy_grp2, "Not at-risk", "Negative")
comp=paste(group1, "vs", group2)

comp_matrix<-data.frame(cps, group1, group2, comp)

for (cp in comp_matrix[,1]){ 
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in three_timepoints){
  
    letter=letters[ind]
    
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)==cp])),
             VarName=cp) %>%
      filter(Marker == mk & Visit == tp)
    
     if(cp=="Hispanic or Latino ethnicity") {
       
       design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
                            
     } else if (cp=="Age, Risk for Severe Covid-19" & ind_comp==2){
      
      design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), grepl(younger_age, Group))
      
    } else if (cp=="Age, Risk for Severe Covid-19" & ind_comp==3) {
      
      design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), grepl(older_age, Group))

    } else {
      
      design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design)
      
    }
    
    mod <- svyby(readout_trunc ~ Group, ~VarName+Visit+Trt_lb+Baseline+Marker, design, svyglm, vartype="ci")
    # flag for if the comparison is reversed, 1 for no reverse, 2 for reverse
    comp_flag <-ifelse(gsub("Group","",colnames(mod)[7]) == comp_matrix[ind_comp,2], 1, 2)
    colnames(mod) <- gsub(paste0(comp_matrix[ind_comp, 2:3],collapse="|"), "", colnames(mod))
    
    tab <- mod %>% 
      rowwise() %>%
      mutate(Ratio=ifelse(comp_flag==1,
                         paste0(decimal_f(10^Group,2),"\n(",decimal_f(10^`ci_l.Group`,2),", ",decimal_f(10^`ci_u.Group`,2),")"),
                         paste0(decimal_f(10^-`Group`,2),"\n(",decimal_f(10^-`ci_u.Group`,2),", ",decimal_f(10^-`ci_l.Group`,2),")"))
             )%>%
      mutate(`Group 1 vs 2`= comp_matrix[ind_comp,4]) %>%
      select(VarName, Visit, Trt_lb, Baseline, Marker, `Group 1 vs 2`, Ratio)
    
    tab_list[[ind]] <- tab
    
    ind=ind+1
    }
  }
  ind_comp=ind_comp+1
}

# comparison
tab_rgmt_v <- do.call("rbind", tab_list)
colnames(tab_rgmt_v) <- c("subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker", "Group 1 vs 2", "Ratios of GMT/GMC")

tab_rgmt_v <- tab_rgmt_v %>%
  left_join(subset(tab_gm_v, Group %in% unlist(comp_matrix[,2:3])) %>% 
              left_join(comp_matrix %>% mutate(subgroup=cps,Group=group1) %>%
                          select(subgroup,Group,comp), 
                        by=c("subgroup", "Group")) %>%
              left_join(comp_matrix %>% mutate(subgroup=cps,Group=group2) %>%
                          select(subgroup,Group,comp), 
                        by=c("subgroup", "Group")) %>%
              mutate(`Group 1 vs 2` = paste0(ifelse(!is.na(comp.x), comp.x, ""),
                                             ifelse(!is.na(comp.y), comp.y, ""))) %>%
              select(-comp.x, -comp.y, -N) %>%
              mutate(Group=ifelse(Group %in% comp_matrix[,2], "Group 1 GMT/GMC", "Group 2 GMT/GMC")) %>%
              rename_with(~ gsub('GMT/GMC', 'GMT', .x)) %>% 
              pivot_wider(names_from=Group, values_from=GMT),
            by=c("Group 1 vs 2", "subgroup", "Visit", "Arm", "Baseline SARS-CoV-2", "Marker")
            )

tab_rgmt_v <- tab_rgmt_v %>% 
  mutate(subgroup = ifelse(grepl(younger_age, `Group 1 vs 2`) & subgroup=="Age, Risk for Severe Covid-19", gsub("Age", younger_age, subgroup), ifelse(grepl(older_age, `Group 1 vs 2`) & subgroup=="Age, Risk for Severe Covid-19", gsub("Age", older_age, subgroup), subgroup)))

tab_rgmt_v <- tab_rgmt[, c("Group 1 vs 2", "subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker")] %>% left_join(tab_rgmt_v[, c("Group 1 vs 2","subgroup","Visit", "Arm","Baseline SARS-CoV-2","Marker","Group 1 GMT/GMC","Group 2 GMT/GMC","Ratios of GMT/GMC")], c("Group 1 vs 2", "subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker"))

testthat::expect_equal(tab_rgmt_v, tab_rgmt)

save(tab_rgmt_v, file = here::here("verification", "verification_output", "immuno_tab_rgmt_v.Rdata"))
```

\clearpage

## Table. Differences in the responder rates, 2FRs, 4FRs between between the vaccine arm and the placebo arm

```{r tab_rrdiff, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}

ind=1
ind_comp=1
tab_list=list()

if (study_name=="COVE") {
  younger_age="Age < 65"; older_age="Age >= 65"
  minortiy_grp1="Communities of color"; minortiy_grp2="White Non-Hispanic"
}
if (study_name=="ENSEMBLE") {
  younger_age="Age 18 - 59"; older_age="Age >= 60"
  minortiy_grp1="URM"; minortiy_grp2="Non-URM"
}

for (cp in c("Arm","Baseline SARS-CoV-2", "Age","Age, Risk for Severe Covid-19","Age, Risk for Severe Covid-19","Sex","Hispanic or Latino ethnicity",VarName_levels[["MinorityC"]],"Risk for Severe Covid-19","HIV Infection")){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in two_timepoints){
      
    comp1 <- case_when(
      cp=="Arm" ~ "Vaccine",
      cp=="Baseline SARS-CoV-2" ~ "Positive",
      cp=="Age" ~ older_age, 
      (cp=="Age, Risk for Severe Covid-19" & ind_comp==4) ~ paste(younger_age,"At-risk"),
      (cp=="Age, Risk for Severe Covid-19" & ind_comp==5) ~ paste(older_age,"At-risk"),
      cp=="Sex" ~ "Male",
      cp=="Hispanic or Latino ethnicity" ~ "Hispanic or Latino",
      cp==VarName_levels[["MinorityC"]] ~ minortiy_grp1,
      cp=="Risk for Severe Covid-19" ~ "At-risk",
      cp=="HIV Infection" ~ "Positive")
    
    comp2 <- case_when(
      cp=="Arm" ~ "Placebo",
      cp=="Baseline SARS-CoV-2" ~ "Negative",
      cp=="Age" ~ younger_age, 
      (cp=="Age, Risk for Severe Covid-19" & ind_comp==4) ~ paste(younger_age, "Not at-risk"),
      (cp=="Age, Risk for Severe Covid-19" & ind_comp==5) ~ paste(older_age, "Not at-risk"),
      cp=="Sex" ~ "Female",
      cp=="Hispanic or Latino ethnicity" ~ "Not Hispanic or Latino",
      cp==VarName_levels[["MinorityC"]] ~ minortiy_grp2,
      cp=="Risk for Severe Covid-19" ~ "Not at-risk",
      cp=="HIV Infection" ~ "Negative")
  
    letter=letters[ind]
    
    # for response
    immuno_design_1 <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)==cp])),
             VarName=cp) %>%
      mutate(Visit=gsub("D57","Day 57", gsub("D29","Day 29", Visit))) %>%
      filter(Marker == mk & Visit == tp)
    
    # for response_2FR, response_4FR
    immuno_design_2 <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)==cp])),
             VarName=cp) %>%
      mutate(Visit=gsub("D57","Day 57", gsub("D29","Day 29", Visit))) %>%
      filter(Visit == paste(tp, "fold-rise over D1")) %>%
      mutate(Visit=gsub(" fold-rise over D1","",Visit)) %>%
      filter(Marker == mk & Visit == tp)
  
    if(cp=="Hispanic or Latino ethnicity") {
       
       design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_1), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
       
       design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_2), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
                            
     } else if (cp=="Age, Risk for Severe Covid-19" & ind_comp==4){
      
      design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_1), grepl(younger_age, Group))
      
      design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_2), grepl(younger_age, Group))
      
    } else if (cp=="Age, Risk for Severe Covid-19" & ind_comp==5) {
      
      design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_1), grepl(older_age, Group))
      
      design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_2), grepl(older_age, Group))

    } else {
      
      design1 <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_1)
      
      design2 <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design_2)
      
    }
  
    mod1 <- svyby(~response, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design1, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod1) <- c(colnames(mod1)[1:7], "mod1ci_l", "mod1ci_u")
    
    mod2 <- svyby(~response_2FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design2, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod2) <- c(colnames(mod2)[1:7], "mod2ci_l", "mod2ci_u")
     
    mod3 <- svyby(~response_4FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design2, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod3) <- c(colnames(mod3)[1:7], "mod3ci_l", "mod3ci_u")
    
    tab <- mod1 %>% 
      left_join(mod2,
                by=groupby_vars) %>%
      left_join(mod3,
                by=groupby_vars) %>%
      mutate(Trt_lb=ifelse(Group==Trt_lb, "-", Trt_lb)) %>%
      mutate(Baseline=ifelse(Group==Baseline & VarName=="Baseline SARS-CoV-2", "-", Baseline)) %>%
      pivot_wider(names_from = Group, values_from = c(response:mod3ci_u)) %>%
      rename_with(~ gsub(comp1, "comp1", gsub(comp2, "comp2", .x, fixed = TRUE))) %>%
      rowwise() %>% 
      mutate(Responder=paste0(round((response_comp1-response_comp2),2),
                               "\n(", round((response_comp1-response_comp2-sqrt((response_comp1-mod1ci_l_comp1)^2+(mod1ci_u_comp2-response_comp2)^2)),2),", ", round((response_comp1-response_comp2+sqrt((response_comp2-mod1ci_l_comp2)^2+(mod1ci_u_comp1-response_comp1)^2)),2),")")) %>%
      mutate(Responder_2FR=paste0(round((response_2FR_comp1-response_2FR_comp2),2),
                               "\n(", round((response_2FR_comp1-response_2FR_comp2-sqrt((response_2FR_comp1-mod2ci_l_comp1)^2+(mod2ci_u_comp2-response_2FR_comp2)^2)),2),", ", round((response_2FR_comp1-response_2FR_comp2+sqrt((response_2FR_comp2-mod2ci_l_comp2)^2+(mod2ci_u_comp1-response_2FR_comp1)^2)),2),")")) %>%
      mutate(Responder_4FR=paste0(round((response_4FR_comp1-response_4FR_comp2),2),
                               "\n(", round((response_4FR_comp1-response_4FR_comp2-sqrt((response_4FR_comp1-mod3ci_l_comp1)^2+(mod3ci_u_comp2-response_4FR_comp2)^2)),2),", ", round((response_4FR_comp1-response_4FR_comp2+sqrt((response_4FR_comp2-mod3ci_l_comp2)^2+(mod3ci_u_comp1-response_4FR_comp1)^2)),2),")")) %>%
      mutate(Comparison=paste(comp1, "vs", comp2)) %>%
      select(VarName, Visit, Baseline, Trt_lb, Marker, Comparison, Responder, Responder_2FR, Responder_4FR)
  
      tab_list[[ind]] <- tab   
     
     ind=ind+1
    }
  }
  ind_comp=ind_comp+1
}

# comparison
tab_rrdiff_v <- do.call("rbind", tab_list)
colnames(tab_rrdiff_v) <- c("subgroup","Visit","Baseline SARS-CoV-2","Arm","Marker","Comparison", "Responder","% 2-Fold Rise","% 4-Fold Rise")

# format
tab_rrdiff_v <- tab_rrdiff_v %>% 
  mutate(subgroup = ifelse(grepl(younger_age, Comparison) & subgroup=="Age, Risk for Severe Covid-19", gsub("Age", younger_age, subgroup), ifelse(grepl(older_age, Comparison) & subgroup=="Age, Risk for Severe Covid-19", gsub("Age", older_age, subgroup), subgroup)))

tab_rrdiff_v <- tab_rrdiff[, c("Comparison", "subgroup", "Baseline SARS-CoV-2", "Arm", "Visit", "Marker")] %>% left_join(tab_rrdiff_v, by=c("Comparison", "subgroup", "Baseline SARS-CoV-2", "Arm", "Visit", "Marker")
)

testthat::expect_equal(tab_rrdiff_v, tab_rrdiff)

save(tab_rrdiff_v, file = here::here("verification", "verification_output", "immuno_tab_rrdiff_v.Rdata"))
```

\clearpage


## Table. Antibody levels in the baseline SARS-CoV-2 negative per-protocol cohort (vaccine vs. placebo)
## Table. Antibody levels in the baseline SARS-CoV-2 positive per-protocol cohort (vaccine vs. placebo)

```{r tab_neg_tab_pos, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}

for (i in c("Negative", "Positive")){

  tab_combine_v <- tab_bind1_v %>% ungroup() %>% filter(`Baseline SARS-CoV-2`==i & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
    #bind_rows(tab_pseudo_v %>% ungroup() %>% filter(`Baseline SARS-CoV-2`==i & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
    left_join(
      tab_gm_v %>% ungroup() %>% filter(`Baseline SARS-CoV-2`==i & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
              by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
      ) %>%
    pivot_wider(names_from=Arm, values_from=c(N,Responder, GMT)) %>%
    left_join(
      tab_rrdiff_v %>% ungroup() %>% filter(`Baseline SARS-CoV-2`==i & subgroup=="Arm") %>% select(-1,-2,-4,-8,-9) %>% rename_with(~ gsub("Responder","rrdiff",.x)),
              by=c("Visit","Baseline SARS-CoV-2","Marker")
      ) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    select(1,2,3,4,6,8,5,7,9,10) 
  
  
  ind=1
  tab_list=list()
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in two_timepoints){
  
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)=="All participants"])),
             VarName="All participants") %>%
      filter(Marker == mk & Visit == tp)
        
    design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), Baseline == i)
    
    mod <- svyby(readout_trunc ~ Trt_lb, ~VarName+Visit+Baseline+Marker, design, svyglm, vartype="ci")
    
    tab <- mod %>% 
      rowwise() %>%
      mutate(`Ratios of GMT`=paste0(decimal_f(10^`Trt_lbVaccine`,2),"\n(",decimal_f(10^ci_l.Trt_lbVaccine,2),", ",decimal_f(10^ci_u.Trt_lbVaccine,2),")")) %>%
      select(2,3,4,11) %>%
      rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
      rename_with(~ gsub("Baseline","Baseline SARS-CoV-2",.x))
    
    tab_list[[ind]] <- tab
  
    ind=ind+1
    }
  }
  
  if (i=="Negative") {
  # comparison
  tab_neg_v <- do.call("rbind", tab_list)
  
  tab_neg_v <- tab_combine_v %>%
    left_join(tab_neg_v,
              by=c("Visit", "Baseline SARS-CoV-2", "Marker")) %>%
    select(-2)

  tab_neg_v <- tab_neg[, c("Visit","Marker")] %>%
    left_join(tab_neg_v, by=c("Visit","Marker"))
  
  testthat::expect_equal(tab_neg_v, tab_neg)
  
  save(tab_neg_v, file = here::here("verification", "verification_output", "immuno_tab_neg_v.Rdata"))
  } else if (i=="Positive"){
    
  # comparison
  tab_pos_v <- do.call("rbind", tab_list)
  
  tab_pos_v <- tab_combine_v %>%
    left_join(tab_pos_v,
              by=c("Visit", "Baseline SARS-CoV-2", "Marker")) %>%
    select(-2)

  tab_pos_v <- tab_pos[, c("Visit","Marker")] %>%
    left_join(tab_pos_v, by=c("Visit","Marker"))
  
  testthat::expect_equal(tab_pos_v, tab_pos)
  
  save(tab_pos_v, file = here::here("verification", "verification_output", "immuno_tab_pos_v.Rdata"))
    
  }
}


```

\clearpage


## Table. Antibody levels in the per-protocol cohort (vaccine recipients)
## Table. Antibody levels in the per-protocol cohort (placebo recipients)

```{r tab_vacc_tab_plcb, results = "asis",  echo=FALSE, message=FALSE, warning=FALSE}

for (i in c("Vaccine", "Placebo")){
  
  tab_combine_v <- tab_bind1_v %>% ungroup() %>% filter(Arm==i & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
    #bind_rows(tab_pseudo_v %>% ungroup() %>% filter(Arm==i & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
    left_join(
      tab_gm_v %>% ungroup() %>% filter(Arm==i & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
              by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
      ) %>%
    rename_with(~ gsub(" SARS-CoV-2","",.x)) %>%
    pivot_wider(names_from=Baseline, values_from=c(N, Responder, GMT)) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x))
  

  # for response rate diff between positive and negative
  ind=1
  ratediff_list=list()
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in two_timepoints){
  
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)=="All participants"])),
             VarName="All participants") %>%
      filter(Marker == mk & Visit == tp)
        
    design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), Trt_lb==i)
    
    mod <- svyby(~response, ~Visit+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
  
    ratediff <- mod %>% 
      pivot_wider(names_from = Baseline, values_from = c(response:ci_u)) %>%
      rowwise() %>% 
      mutate(rrdiff=paste0(round((response_Positive-response_Negative),2),
                                 "\n(", round((response_Positive-response_Negative-sqrt((response_Positive-ci_l_Positive)^2+(ci_u_Negative-response_Negative)^2)),2),", ", round((response_Positive-response_Negative+sqrt((response_Negative-ci_l_Negative)^2+(ci_u_Positive-response_Positive)^2)),2),")")) %>%
      rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
      select(Visit, Marker, rrdiff)
    
    ratediff_list[[ind]] <- ratediff 
  
    ind=ind+1
    }
  }
  ratediff_all <- do.call("rbind", ratediff_list)
  
  # for magnitude ratio between positive and negative
  ind=1
  magdiff_list=list()
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)"
               #,"Pseudovirus-nAb ID50","Pseudovirus-nAb ID80"
               )){
    for (tp in two_timepoints){
  
    immuno_design <- dat.long %>%
      mutate(Group=(!!sym(names(VarName_levels)[unlist(VarName_levels)=="All participants"])),
             VarName="All participants") %>%
      filter(Marker == mk & Visit == tp)
        
    design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = immuno_design), Trt_lb==i)
    
    mod <- svyby(readout_trunc~Baseline, ~Visit+Marker, design, survey::svyglm, vartype="ci")
  
    magdiff <- mod %>% 
      rowwise() %>% 
      mutate(`Ratios of GMT`=paste0(decimal_f(10^BaselinePositive,2),"\n(",decimal_f(10^ci_l.BaselinePositive,2),", ",decimal_f(10^ci_u.BaselinePositive,2),")")) %>%
      rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
      select(1,2,9)
    
    magdiff_list[[ind]] <- magdiff 
  
    ind=ind+1
    }
  }
  magdiff_all <- do.call("rbind", magdiff_list)
  
  if (i=="Vaccine") {

  # comparison
  tab_vacc_v <- tab_combine_v %>%
    left_join(ratediff_all, by=c("Visit","Marker")) %>%
    left_join(magdiff_all, by=c("Visit","Marker")) %>%
    select(1,3,5,7,9,4,6,8,10,11)    
  
  tab_vacc_v <- tab_vacc[, c("Visit","Marker")] %>%
    left_join(tab_vacc_v, by=c("Visit","Marker"))
  
  testthat::expect_equal(tab_vacc_v, tab_vacc)
  
  save(tab_vacc_v, file = here::here("verification", "verification_output", "immuno_tab_vacc_v.Rdata"))
  } else if (i=="Placebo"){
    
  # comparison
  tab_plcb_v <- tab_combine_v %>%
  left_join(ratediff_all, by=c("Visit","Marker")) %>%
  left_join(magdiff_all, by=c("Visit","Marker")) %>%
  select(1,3,5,7,9,4,6,8,10,11)

  dim(tab_plcb_v)==dim(tab_plcb)
  
  tab_plcb[] <- lapply(tab_plcb, as.character)
  tab_plcb_v[] <- lapply(tab_plcb_v, as.character)
  
  tab_plcb_v <- tab_plcb[, c("Visit","Marker")] %>%
    left_join(tab_plcb_v, by=c("Visit","Marker"))
  
  testthat::expect_equal(tab_plcb_v, tab_plcb)
  
  save(tab_plcb_v, file = here::here("verification", "verification_output", "immuno_tab_plcb_v.Rdata"))
  }
}
  
```

\clearpage